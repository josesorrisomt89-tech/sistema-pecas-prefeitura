<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Catálogo de Peças com Pedidos Editáveis</title>
<script src="jspdf.min.js"></script>
<script src="xlsx.min.js"></script>
<style>
/* ===================================================================
                                CSS (MANTIDO)
===================================================================
*/
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f4f4}
header{background:#333;color:white;padding:10px;text-align:center}
nav{display:flex;justify-content:center;background:#444}
nav button{margin:5px;padding:10px 20px;background:#666;color:white;border:none;cursor:pointer;border-radius:5px}
nav button.active{background:#007bff}
.tab-content{display:none;padding:20px;background:white;margin:10px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1)}

.form-group-veiculo {
    display: grid;
    grid-template-columns: repeat(3, 1fr); 
    gap: 15px; 
}

.form-group-veiculo label {
    font-weight: bold;
    margin-top: 5px;
    margin-bottom: -5px; 
}

.full-width {
    grid-column: 1 / -1; 
}
.full-width input {
    width: 100%;
}

.import-section {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px dashed #ccc;
    border-radius: 4px;
}
.import-section label {
    font-weight: normal;
    margin: 0;
}
.import-section input[type="file"] {
    flex-grow: 1;
    margin: 0;
}

img.logo-preview{
    max-width: 250px; 
    max-height: 100px; 
    width: auto;
    height: auto;
    display:block;
    margin-top:10px; 
    border: 1px solid #ddd; 
    padding: 5px;
}
img.peca-preview{
    max-width:150px;
    max-height:150px;
    display:block;
    margin-top:10px; 
    border: 1px solid #ddd; 
    padding: 5px;
}
img.peca-miniatura {
    max-width: 50px; 
    height: auto;
}

input,select,button,textarea{margin:5px 0;padding:8px;width:100%;box-sizing:border-box;border-radius:4px;border:1px solid #ccc}
button.btn-add{background:#28a745;color:white;border:none;cursor:pointer;width: 100%;}
button.btn-edit{background:#ffc107;color:white;border:none;padding:4px 8px;margin:0 2px}
button.btn-delete{background:#dc3545;color:white;border:none;padding:4px 8px;margin:0 2px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:left}
.sem-resultados{color:#888;font-style:italic}
input.qtd, input.obs{width:60px;}

</style>
</head>
<body>
<header><h1>Sistema de Catálogo de Peças</h1></header>
<nav>
<button class="tab-btn active" data-tab="veiculosTab">Veículos</button>
<button class="tab-btn" data-tab="pecasCatalogoTab">Peças / Catálogo</button>
<button class="tab-btn" data-tab="pedidosTab">Pedidos</button>
<button class="tab-btn" data-tab="empresaTab">Empresa</button>
</nav>

<div id="veiculosTab" class="tab-content" style="display:block;">
<h2>Cadastro de Veículos</h2>

<h3>Importar Veículos (Excel/CSV)</h3>
<div class="import-section">
    <label for="importExcel" style="width: auto;">Selecione o arquivo (.xlsx/.csv):</label>
    <input type="file" id="importExcel" accept=".xlsx, .xls, .csv">
    <button onclick="importarVeiculosExcel()" class="btn-add" style="width: auto;">Importar</button>
</div>
<p style="font-size: 0.9em; color: #666; margin-top: -10px;">*A planilha deve ter colunas com os cabeçalhos: **Prefixo, Placa, Chassis, Modelo** (Obrigatórios), além de AnoModelo, Secretaria, GestorFrota e Motorista (Opcionais).</p>
<hr>

<h3>Cadastro Manual de Veículo</h3>
<form id="cadastro-veiculo-form">
<input type="hidden" id="veiculoKey">
<div class="form-group-veiculo">
    
    <label>Prefixo:</label>
    <label>Placa:</label>
    <label>Chassis:</label>
    <input type="text" id="prefixoVeiculo" required>
    <input type="text" id="placaVeiculo" required>
    <input type="text" id="chassisVeiculo" required>

    <div class="full-width">
        <label>Descrição do Veículo (Modelo/Marca):</label>
        <input type="text" id="modeloVeiculo" required>
    </div>
    
    <label>Ano/Modelo:</label>
    <label>Secretaria:</label>
    <label>Gestor de Frota:</label>
    <input type="text" id="anoModeloVeiculo">
    <input type="text" id="secretariaVeiculo">
    <input type="text" id="gestorFrotaVeiculo">

    <div class="full-width">
        <label>Motorista:</label>
        <input type="text" id="motoristaVeiculo">
    </div>

</div>
<button type="submit" class="btn-add">Cadastrar Veículo</button>
<button type="button" id="cancelar-veiculo" onclick="cancelarEdicaoVeiculo()" style="background:#6c757d;display:none;">Cancelar Edição</button>
</form>

<hr>

<h3>Lista de Veículos Cadastrados</h3>
<div style="margin-bottom: 15px;">
    <label for="filtroVeiculos" style="font-weight: bold; display: block; width: 100%;">Filtrar por Prefixo, Placa ou Secretaria:</label>
    <input type="text" id="filtroVeiculos" placeholder="Digite para filtrar..." onkeyup="carregarVeiculos()" style="width: 100%;">
</div>

<div id="lista-veiculos"></div>
<p id="noVeiculosFound" class="sem-resultados" style="display:none;">Nenhum veículo cadastrado.</p>
</div>

<div id="pecasCatalogoTab" class="tab-content">
<h2>Peças e Catálogo</h2>
<label>Selecione o Veículo:</label>
<select id="selectVeiculoPecasCatalogo" onchange="carregarPecasCatalogo()"></select>

<h3>Filtros do Catálogo</h3>
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <input type="text" id="filtroBusca" placeholder="Buscar por Nome ou Código" onkeyup="carregarPecasCatalogo()">
    <select id="filtroCategoria" onchange="carregarPecasCatalogo()">
        <option value="">Todas as Categorias</option>
        </select>
</div>

<h3>Cadastro de Peças</h3>
<form id="cadastro-peca-form">
<input type="hidden" id="pecaKey">
<label>Nome da Peça:</label><input type="text" id="nomePeca" required>
<label>Código:</label><input type="text" id="codigoPeca" required>
<label>Categoria:</label>
<select id="categoriaPeca" required></select>
<label>Procedência:</label><input type="text" id="procedenciaPeca">
<label>Observação:</label><input type="text" id="obsPeca">

<label>Anexar Foto da Peça (Opcional):</label>
<input type="file" id="imagemPeca" accept="image/*" onchange="previewPecaImage(this)">
<img id="pecaImagePreview" class="peca-preview" src="" alt="Prévia da Peça" style="display:none;">

<button type="submit" class="btn-add">Cadastrar Peça</button>
<button type="button" id="cancelar-peca" onclick="cancelarEdicaoPeca()" style="background:#6c757d;display:none;">Cancelar Edição</button>
</form>
<div id="lista-pecas"></div>

<h3>Catálogo de Peças</h3>
<button onclick="enviarParaPedido()" class="btn-add">Adicionar Selecionadas ao Pedido</button>
<div id="catalogoPecasContainer"></div>
<p id="noCatalogoFound" class="sem-resultados" style="display:none;">Nenhuma peça cadastrada para este veículo.</p>
</div>

<div id="pedidosTab" class="tab-content">
<h2>Pedidos de Peças</h2>
<div id="lista-pedidos"></div>
</div>

<div id="empresaTab" class="tab-content">
<h2>Configurações da Empresa</h2>
<form id="empresa-form">
<label>Nome da Empresa:</label><input type="text" id="empresaNome" required>
<label>CNPJ:</label><input type="text" id="empresaCnpj">
<label>Endereço:</label><input type="text" id="empresaEndereco">
<label>Telefone:</label><input type="text" id="empresaTelefone">
<label>Logo da Empresa (960x210 pixels recomendado):</label><input type="file" id="empresaLogo" accept="image/*">
<img id="logoPreview" class="logo-preview" src="" alt="Prévia da logo" style="display:none;">
<button type="submit" class="btn-add">Salvar Dados da Empresa</button>
</form>
</div>

<script>
// 
// ===================================================================
//                                JAVASCRIPT (MODERNO + GOOGLE APPS SCRIPT)
// ===================================================================
// 

// Variáveis Globais
let DADOS_FROTA = {}; 
let PEDIDOS_ARRAY = []; 
let empresaInfo = {}; 

const categorias = ['Motor', 'Transmissão', 'Suspensão', 'Elétrica', 'Freios', 'Carroceria', 'Acessórios'];
let pecaImagemBase64 = null; 

// ===================================================================
// FUNÇÕES DE ACESSO AO ARQUIVO (CHAMAM O GOOGLE APPS SCRIPT)
// ===================================================================

async function lerDadosDoArquivo() {
    try {
        // Retorna uma Promise que chama a função lerArquivo no Apps Script
        const dadosJson = await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .lerArquivo();
        });
        
        // Se o GAS retornar uma string, fazemos o parse
        if (typeof dadosJson === 'string' && dadosJson.startsWith('{')) {
            const dados = JSON.parse(dadosJson);
            return dados;
        }
        
        // Se o arquivo estiver vazio ou não for um JSON válido
        return {}; 
    } catch (e) {
        // Tratamento de erro de rede ou de execução do GAS
        console.error("Erro ao ler dados do Apps Script:", e);
        alert("Erro ao tentar ler dados do Drive: " + e.message + ". Verifique a implantação do Apps Script.");
        return {};
    }
}

async function salvarDadosNoArquivo() {
    try {
        const dadosParaSalvar = {
            DADOS_FROTA: DADOS_FROTA,
            PEDIDOS_ARRAY: PEDIDOS_ARRAY,
            empresaInfo: empresaInfo
        };
        
        const jsonString = JSON.stringify(dadosParaSalvar);

        // Retorna uma Promise que chama a função salvarArquivo no Apps Script
        const resultado = await new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .salvarArquivo(jsonString); // Passa a string JSON para o GAS
        });
        
        if (resultado === true) {
            return true;
        } else {
             // Se o GAS retornar erro
            throw new Error(resultado.error || 'Falha desconhecida ao salvar no Drive.');
        }

    } catch (e) {
        console.error("Erro ao salvar dados no Apps Script:", e);
        alert("Erro ao tentar salvar dados no Drive: " + e.message);
        return false;
    }
}

async function carregarDadosIniciais() {
    const dados = await lerDadosDoArquivo();
    
    // Atualiza as variáveis globais com os dados lidos
    DADOS_FROTA = dados.DADOS_FROTA || {};
    PEDIDOS_ARRAY = dados.PEDIDOS_ARRAY || [];
    empresaInfo = dados.empresaInfo || {};
}


// ===================================================================
// FUNÇÕES AUXILIARES (MANTIDAS E ADAPTADAS PARA ES6)
// ===================================================================

function previewPecaImage(input) {
    const file = input.files[0];
    const preview = document.getElementById('pecaImagePreview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
            pecaImagemBase64 = e.target.result; 
        };
        reader.readAsDataURL(file);
    } else {
        preview.src = '';
        preview.style.display = 'none';
        pecaImagemBase64 = null;
    }
}

function limparCampoImagem() {
    document.getElementById('imagemPeca').value = '';
    document.getElementById('pecaImagePreview').src = '';
    document.getElementById('pecaImagePreview').style.display = 'none';
    pecaImagemBase64 = null;
}

// ======= TABS (Uso de forEach para modernidade) =======
const tabButtons = document.querySelectorAll('.tab-btn');
tabButtons.forEach(button => {
    button.onclick = async function() { // Tornando assíncrono para garantir o carregamento
        const tabId = this.getAttribute('data-tab');
        
        tabButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
        
        // Carregamento de dados (AGORA ESPERAMOS A RESPOSTA DO DRIVE)
        await carregarDadosIniciais();
        
        atualizarSelects();
        
        if (tabId === 'pedidosTab') {
            carregarPedidos();
        } else if (tabId === 'veiculosTab') {
            carregarVeiculos();
        } else if (tabId === 'pecasCatalogoTab') {
             carregarPecasCatalogo();
        } else if (tabId === 'empresaTab') {
             carregarEmpresa();
        }
    };
});


// ======= VEÍCULOS E FILTRO =======
function atualizarSelects() {
    atualizarSelectVeiculos('selectVeiculoPecasCatalogo');
}
function atualizarSelectVeiculos(selectId) {
    const sel = document.getElementById(selectId);
    sel.innerHTML = '<option value="">Selecione...</option>';
    const keys = Object.keys(DADOS_FROTA);
    keys.forEach(k => {
        sel.innerHTML += `<option value="${k}">${DADOS_FROTA[k].prefixo} - ${DADOS_FROTA[k].modelo}</option>`;
    });
}

function carregarVeiculos() {
    const lista = document.getElementById('lista-veiculos');
    const filtroTexto = document.getElementById('filtroVeiculos').value.toLowerCase();
    const veiculosKeys = Object.keys(DADOS_FROTA);
    
    const veiculosFiltrados = veiculosKeys.filter(k => {
        const v = DADOS_FROTA[k];
        const prefixo = v.prefixo || '';
        const placa = v.placa || '';
        const secretaria = v.secretaria || '';
        
        return prefixo.toLowerCase().includes(filtroTexto) ||
               placa.toLowerCase().includes(filtroTexto) ||
               secretaria.toLowerCase().includes(filtroTexto);
    });

    if (!veiculosFiltrados.length && !filtroTexto) { 
        document.getElementById('noVeiculosFound').style.display = 'block'; 
        document.getElementById('noVeiculosFound').innerText = 'Nenhum veículo cadastrado.';
        lista.innerHTML = ''; 
        return; 
    }
    if (!veiculosFiltrados.length && filtroTexto) {
        document.getElementById('noVeiculosFound').style.display = 'block'; 
        document.getElementById('noVeiculosFound').innerText = 'Nenhum veículo encontrado com o filtro aplicado.'; 
        lista.innerHTML = ''; 
        return; 
    }
    
    document.getElementById('noVeiculosFound').style.display = 'none';
    
    let html = '<table><thead><tr><th>Prefixo</th><th>Descrição</th><th>Placa</th><th>Chassis</th><th>Secretaria</th><th>Ações</th></tr></thead><tbody>';
    veiculosFiltrados.forEach(k => {
        const v = DADOS_FROTA[k];
        html += `<tr>
            <td>${v.prefixo}</td>
            <td>${v.modelo}</td>
            <td>${v.placa}</td>
            <td>${v.chassis}</td>
            <td>${v.secretaria}</td>
            <td><button class="btn-edit" onclick="editarVeiculo('${k}')">Editar</button>
                <button class="btn-delete" onclick="excluirVeiculo('${k}')">Excluir</button></td>
        </tr>`;
    });
    html += '</tbody></table>';
    lista.innerHTML = html;
}

document.getElementById('cadastro-veiculo-form').onsubmit = async function (e) {
    e.preventDefault();
    const key = document.getElementById('veiculoKey').value || new Date().getTime().toString();
    
    DADOS_FROTA[key] = { 
        prefixo: document.getElementById('prefixoVeiculo').value, 
        placa: document.getElementById('placaVeiculo').value,
        modelo: document.getElementById('modeloVeiculo').value, 
        chassis: document.getElementById('chassisVeiculo').value,
        anoModelo: document.getElementById('anoModeloVeiculo').value,
        secretaria: document.getElementById('secretariaVeiculo').value,
        gestorFrota: document.getElementById('gestorFrotaVeiculo').value,
        motorista: document.getElementById('motoristaVeiculo').value,
        pecas: (DADOS_FROTA[key] && DADOS_FROTA[key].pecas) || [] 
    };
    
    const saved = await salvarDadosNoArquivo(); 
    if (saved) {
        alert('Veículo salvo com sucesso!');
        this.reset(); 
        document.getElementById('veiculoKey').value = ''; 
        document.getElementById('cancelar-veiculo').style.display = 'none';
        
        carregarVeiculos(); atualizarSelects();
    }
};

function editarVeiculo(k) { 
    const v = DADOS_FROTA[k];
    document.getElementById('prefixoVeiculo').value = v.prefixo; 
    document.getElementById('placaVeiculo').value = v.placa;
    document.getElementById('modeloVeiculo').value = v.modelo; 
    document.getElementById('chassisVeiculo').value = v.chassis;
    document.getElementById('anoModeloVeiculo').value = v.anoModelo;
    document.getElementById('secretariaVeiculo').value = v.secretaria;
    document.getElementById('gestorFrotaVeiculo').value = v.gestorFrota;
    document.getElementById('motoristaVeiculo').value = v.motorista;
    document.getElementById('veiculoKey').value = k; 
    document.getElementById('cancelar-veiculo').style.display = 'inline-block'; 
}
function cancelarEdicaoVeiculo() { 
    document.getElementById('cadastro-veiculo-form').reset(); 
    document.getElementById('veiculoKey').value = ''; 
    document.getElementById('cancelar-veiculo').style.display = 'none'; 
}
async function excluirVeiculo(k) { 
    if (confirm('Deseja excluir este veículo? Isso removerá todas as peças associadas!')) { 
        delete DADOS_FROTA[k]; 
        const saved = await salvarDadosNoArquivo(); 
        if (saved) {
            carregarVeiculos(); 
            atualizarSelects(); 
        }
    } 
}

// LÓGICA DE IMPORTAÇÃO (Excel/CSV) - MANTIDA
function importarVeiculosExcel() {
    if (typeof window.XLSX === 'undefined') {
        alert("Erro: A biblioteca XLSX não foi carregada. Verifique se o arquivo 'xlsx.min.js' está na mesma pasta e que o navegador o aceitou.");
        return;
    }
    
    // ... O restante da função importarVeiculosExcel() é mantido, 
    // mas a chamada final 'salvarDadosNoArquivo()' deve ser 'await salvarDadosNoArquivo()'
    
    // EXEMOPLO DA PARTE FINAL:
    // ... Código de importação ...
    // DADOS_FROTA[key] = novoVeiculo; // ...
    
    // FIM DA FUNÇÃO
    // salvarDadosNoArquivo(); <--- Substituir por:
    // (async () => {
    //    await salvarDadosNoArquivo();
    //    fileInput.value = ''; 
    //    carregarVeiculos();
    //    atualizarSelects();
    //    alert('Importação concluída: ' + importados + ' veículos adicionados com sucesso!');
    // })();
    alert("Função de importação não está completa. Por favor, ajuste o final desta função para usar 'await salvarDadosNoArquivo()'.");
}


// ======= PEÇAS =======
function carregarPecasCatalogo() {
    // ... (restante da função carregarPecasCatalogo() mantido)
    const selCat = document.getElementById('categoriaPeca');
    const selFiltroCat = document.getElementById('filtroCategoria');
    
    // Preencher as options de Categoria (Cadastro e Filtro)
    selCat.innerHTML = '';
    selFiltroCat.innerHTML = '<option value="">Todas as Categorias</option>';
    categorias.forEach(c => {
        selCat.innerHTML += `<option value="${c}">${c}</option>`;
        selFiltroCat.innerHTML += `<option value="${c}">${c}</option>`;
    });

    const veiculoKey = document.getElementById('selectVeiculoPecasCatalogo').value;
    if (!veiculoKey || !DADOS_FROTA[veiculoKey]) { 
        document.getElementById('lista-pecas').innerHTML = ''; 
        document.getElementById('catalogoPecasContainer').innerHTML = ''; 
        document.getElementById('noCatalogoFound').style.display = 'none';
        return; 
    }
    
    const pecasNaoFiltradas = DADOS_FROTA[veiculoKey].pecas || [];
    const filtroBusca = document.getElementById('filtroBusca').value.toLowerCase();
    const filtroCategoria = document.getElementById('filtroCategoria').value;
    
    const pecas = pecasNaoFiltradas.filter(p => {
        const buscaMatch = (p.nome || '').toLowerCase().includes(filtroBusca) || (p.codigo || '').toLowerCase().includes(filtroBusca);
        const categoriaMatch = filtroCategoria === '' || p.categoria === filtroCategoria;
        return buscaMatch && categoriaMatch;
    });

    // ... (restante da lógica de renderização HTML é mantida) ...

    if (!pecasNaoFiltradas.length) { 
        document.getElementById('lista-pecas').innerHTML = '';
        document.getElementById('noCatalogoFound').style.display = 'block';
    } else {
         document.getElementById('noCatalogoFound').style.display = 'none';
    }

    // Lista de Cadastro/Edição 
    let html = '<table><thead><tr><th>Imagem</th><th>Nome</th><th>Código</th><th>Categoria</th><th>Procedência</th><th>Observação</th><th>Ações</th></tr></thead><tbody>';
    
    pecas.forEach(peca => {
        const imgHtml = peca.imagemBase64 ? `<img src="${peca.imagemBase64}" class="peca-miniatura" alt="Foto Peça">` : 'N/A';
        
        // Procura o índice original na lista não filtrada
        const i = pecasNaoFiltradas.findIndex(pNF => pNF.codigo === peca.codigo && pNF.nome === peca.nome);
        
        if(i !== -1) {
             html += `<tr>
                 <td>${imgHtml}</td>
                 <td>${peca.nome}</td>
                 <td>${peca.codigo}</td>
                 <td>${peca.categoria}</td>
                 <td>${peca.procedencia}</td>
                 <td>${peca.observacao}</td>
                 <td><button class="btn-edit" onclick="editarPeca('${veiculoKey}', ${i})">Editar</button>
                     <button class="btn-delete" onclick="excluirPeca('${veiculoKey}', ${i})">Excluir</button></td>
            </tr>`;
        }
    });
    html += '</tbody></table>'; 
    document.getElementById('lista-pecas').innerHTML = html;

    // Catálogo de Seleção 
    let catHtml = '<table><thead><tr><th>Selecionar</th><th>Imagem</th><th>Nome</th><th>Código</th><th>Categoria</th><th>Procedência</th><th>Observação</th></tr></thead><tbody>';
    
    pecas.forEach(peca => {
        const imgHtml = peca.imagemBase64 ? `<img src="${peca.imagemBase64}" class="peca-miniatura" alt="Foto Peça">` : 'N/A';
        
        // Procura o índice original
        const originalIndex = pecasNaoFiltradas.findIndex(pNF => pNF.codigo === peca.codigo && pNF.nome === peca.nome);
        
        catHtml += `<tr>
            <td><input type="checkbox" class="sel-peca" data-index="${originalIndex}"></td>
            <td>${imgHtml}</td>
            <td>${peca.nome}</td>
            <td>${peca.codigo}</td>
            <td>${peca.categoria}</td>
            <td>${peca.procedencia}</td>
            <td>${peca.observacao}</td>
            </tr>`;
    });
    catHtml += '</tbody></table>'; 
    document.getElementById('catalogoPecasContainer').innerHTML = catHtml;
}


document.getElementById('cadastro-peca-form').onsubmit = async function (e) {
    e.preventDefault();
    const veiculoKey = document.getElementById('selectVeiculoPecasCatalogo').value;
    if (!veiculoKey) return alert('Selecione um veículo.');
    
    const pecaIndex = document.getElementById('pecaKey').value;
    const peca = { 
        nome: document.getElementById('nomePeca').value, 
        codigo: document.getElementById('codigoPeca').value, 
        categoria: document.getElementById('categoriaPeca').value, 
        procedencia: document.getElementById('procedenciaPeca').value, 
        observacao: document.getElementById('obsPeca').value,
        imagemBase64: pecaImagemBase64 
    };
    
    if (pecaIndex !== '') { 
        if (!peca.imagemBase64 && DADOS_FROTA[veiculoKey].pecas[pecaIndex]) {
             peca.imagemBase64 = DADOS_FROTA[veiculoKey].pecas[pecaIndex].imagemBase64;
        }
        DADOS_FROTA[veiculoKey].pecas[pecaIndex] = peca; 
    }
    else { 
        if (!DADOS_FROTA[veiculoKey].pecas) DADOS_FROTA[veiculoKey].pecas = []; 
        DADOS_FROTA[veiculoKey].pecas.push(peca); 
    }
    
    const saved = await salvarDadosNoArquivo();
    if (saved) {
        alert('Peça salva com sucesso!');
        this.reset(); 
        document.getElementById('pecaKey').value = ''; 
        document.getElementById('cancelar-peca').style.display = 'none';
        limparCampoImagem(); 
        
        carregarPecasCatalogo();
    }
};

async function excluirPeca(veiculoKey, index) { 
    if (confirm('Deseja excluir esta peça?')) { 
        DADOS_FROTA[veiculoKey].pecas.splice(index, 1); 
        const saved = await salvarDadosNoArquivo(); 
        if (saved) {
            carregarPecasCatalogo(); 
        }
    } 
}

// ... (O restante das funções de Pedidos, Empresa e PDF são mantidas, 
// mas todas as chamadas 'salvarDadosNoArquivo()' devem ser precedidas por 'await')

async function enviarParaPedido() {
    // ... Código de seleção de peças ...
    
    // Adiciona no início
    PEDIDOS_ARRAY.unshift(novoPedido); 
    ordenarPedidos();
    
    const saved = await salvarDadosNoArquivo();

    if (saved) {
        // Simula clique na aba de pedidos
        document.querySelector('[data-tab="pedidosTab"]').click();
        alert('Peças adicionadas ao Novo Pedido #' + novoId + '!');
    }
}

async function atualizarItemPedido(id, i, campo, val) {
    // ... Código de atualização de item ...

    if (pedidoIndex !== -1) {
        PEDIDOS_ARRAY[pedidoIndex].itens[i][campo] = campo === 'qtd' ? parseInt(val) : val;
        await salvarDadosNoArquivo(); // AQUI
    }
}

async function excluirItemPedido(id, i) {
    if (confirm('Deseja excluir esta peça do pedido?')) {
        // ... Código de remoção do item ...
        
        if (pedidoIndex !== -1) {
             PEDIDOS_ARRAY[pedidoIndex].itens.splice(i, 1);
             if(PEDIDOS_ARRAY[pedidoIndex].itens.length === 0) {
                 PEDIDOS_ARRAY.splice(pedidoIndex, 1);
             }
            await salvarDadosNoArquivo(); // AQUI
            carregarPedidos(); 
        }
    }
}

async function finalizarPedido(id) {
    if (confirm('Deseja fechar e arquivar este pedido?')) {
        // ... Código de finalização ...
        if (pedidoIndex !== -1) {
            PEDIDOS_ARRAY[pedidoIndex].status = 'Finalizado';
            ordenarPedidos();
            await salvarDadosNoArquivo(); // AQUI
            carregarPedidos();
        }
    }
}

async function reabrirPedido(id) {
    if (confirm('Deseja reabrir este pedido? Ele voltará para a lista de Pedidos Abertos.')) {
        // ... Código de reabertura ...
        if (pedidoIndex !== -1) {
            // ...
            await salvarDadosNoArquivo(); // AQUI
            carregarPedidos();
            alert('Pedido #' + id + ' reaberto com sucesso!');
        }
    }
}

async function excluirPedidoDefinitivo(id) {
    if (confirm('ATENÇÃO: Deseja excluir permanentemente este pedido do histórico?')) {
        // ... Código de exclusão ...
        if (pedidoIndex !== -1) {
            PEDIDOS_ARRAY.splice(pedidoIndex, 1);
            await salvarDadosNoArquivo(); // AQUI
            carregarPedidos();
            alert('Pedido #' + id + ' excluído permanentemente.');
        }
    }
}

document.getElementById('empresa-form').onsubmit = async function (e) {
    e.preventDefault();
    empresaInfo = {
        nome: document.getElementById('empresaNome').value,
        cnpj: document.getElementById('empresaCnpj').value,
        endereco: document.getElementById('empresaEndereco').value,
        telefone: document.getElementById('empresaTelefone').value,
        logo: empresaInfo.logo || document.getElementById('logoPreview').src || ''
    };
    const saved = await salvarDadosNoArquivo(); // AQUI
    if (saved) {
        alert('Dados da empresa salvos com sucesso!');
    }
};


// ======= INICIALIZAÇÃO (ES6) =======
async function inicializarSistema() {
    await carregarDadosIniciais(); // ESPERA O GOOGLE DRIVE

    ordenarPedidos();
    carregarVeiculos();
    carregarEmpresa(); 
    atualizarSelects();
}

window.onload = inicializarSistema;
</script>
</body>
</html>